<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <record id="view_sale_credit_quota_application_form" model="ir.ui.view">
            <field name="name">sale.credit.quota.application.form</field>
            <field name="model">sale.credit.quota.application</field>
            <field name="arch" type="xml">
                <form string="Solicitud de Cupo">
                    <header>
                        <field name="state" widget="statusbar" statusbar_visible="draft,approved,finished,rejected"/>
                        <button string="Enviar a Aprobación" 
                                name="action_send_to_approval" 
                                type="object" 
                                class="btn btn-primary"
                                invisible="state != 'draft' or approval_request_id"
                                confirm="¿Está seguro de que desea enviar esta solicitud a aprobación? Se validarán todos los requisitos mínimos."/>
                        <button string="Finalizar" 
                                name="action_finish" 
                                type="object" 
                                class="btn btn-warning"
                                invisible="state != 'approved'"
                                confirm="¿Está seguro de que desea finalizar esta solicitud? Los cupos del cliente se restablecerán a 0."/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_approval_request" 
                                    type="object" 
                                    class="oe_stat_button" 
                                    icon="fa-check-square-o"
                                    invisible="not approval_request_id">
                                <div class="o_stat_info">
                                    <span class="o_stat_text">Solicitud de</span>
                                    <span class="o_stat_text">Aprobación</span>
                                </div>
                            </button>
                            <button name="action_view_customer_children" 
                                    type="object" 
                                    class="oe_stat_button" 
                                    icon="fa-users"
                                    invisible="not customer_id">
                                <field name="customer_child_count" widget="statinfo" string="Clientes Hijos"/>
                            </button>
                            <button name="action_view_customer_purchases" 
                                    type="object" 
                                    class="oe_stat_button" 
                                    icon="fa-shopping-cart"
                                    invisible="not customer_id">
                                <field name="count_purchased" widget="statinfo" string="Compras"/>
                            </button>
                        </div>
                        
                        <!-- Campos invisibles para evaluación de condiciones -->
                        <field name="arrears_amount_debt" invisible="1"/>
                        <field name="approval_request_id" invisible="1"/>
                        
                        <!-- Alerta de deuda en mora -->
                        <div class="p-3 mb-3 border border-danger rounded" style="background-color:rgba(203, 34, 48, 0.26);" invisible="arrears_amount_debt == 0">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-exclamation-triangle fa-2x me-3 text-danger" title="Advertencia de deuda en mora"/>
                                <div>
                                    <h4 class="mb-1 text-danger">
                                        <strong>CLIENTE CON DEUDA EN MORA</strong>
                                    </h4>
                                    <p class="mb-1">
                                        Este cliente tiene facturas vencidas hace más de 30 días por un monto de:
                                        <strong class="text-danger">
                                            <field name="arrears_amount_debt" widget="monetary" readonly="1"/>
                                        </strong>
                                    </p>
                                    <small class="text-muted">
                                        Evalúe cuidadosamente antes de aprobar nuevo cupo de crédito.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="o_primary">
                            <h1>
                                <field name="name" placeholder="SC-YYYYMM-00001" readonly="1" />
                            </h1>
                        </div>
                        <group col="2">
                            <group string="Información del Cliente">
                                <field name="customer_id" options="{'no_create': True}" readonly="state in ['approved', 'rejected', 'finished']"/>
                                <field name="customer_vat" readonly="state in ['approved', 'rejected', 'finished']"/>
                                <field name="is_legal_entity" readonly="state in ['approved', 'rejected', 'finished']"/>
                                <field name="customer_phone" widget="phone" placeholder="Teléfono" readonly="state in ['approved', 'rejected', 'finished']"/>
                                <field name="customer_mobile" widget="phone" placeholder="Teléfono Móvil" readonly="state in ['approved', 'rejected', 'finished']"/>
                                <field name="customer_email" readonly="state in ['approved', 'rejected', 'finished']"/>
                                <field name="customer_birth_date" readonly="state in ['approved', 'rejected', 'finished']"/>
                                <label for="customer_address" string="Dirección"/>
                                <div class="o_row">
                                    <field name="customer_address" placeholder="Dirección" class="oe_inline" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    <field name="customer_city" placeholder="Ciudad" class="oe_inline" readonly="state in ['approved', 'rejected', 'finished']"/>
                                </div>
                                <field name="customer_years_of_activity" readonly="state in ['approved', 'rejected', 'finished']"/>
                            </group>
                            
                            <group string="Información de la Solicitud">
                                <field name="subject" readonly="state in ['approved', 'rejected', 'finished']"/>
                                <field name="branch_office" readonly="state in ['approved', 'rejected', 'finished']"/>
                                <field name="application_date" readonly="state in ['approved', 'rejected', 'finished']"/>
                                <field name="rejected_date" invisible="state != 'rejected'" readonly="1"/>
                                <field name="user_id" options="{'no_create': True}" readonly="state in ['approved', 'rejected', 'finished']"/>
                                <field name="approval_request_id" invisible="not approval_request_id" readonly="1"/>
                            </group>
                        </group>

                        <notebook>
                            <page string="Codeudores">
                                <field name="codeudor_ids" readonly="state in ['approved', 'rejected', 'finished']">
                                    <kanban class="o_kanban_mobile">
                                        <field name="name"/>
                                        <field name="vat"/>
                                        <field name="phone"/>
                                        <field name="email"/>
                                        <field name="relationship"/>
                                        <field name="age"/>
                                        <field name="residence_address"/>
                                        <field name="residence_municipality"/>
                                        <field name="birth_date"/>
                                        <templates>
                                            <t t-name="card" class="flex-row">
                                                <aside class="o_kanban_aside_full">
                                                    <div class="o_kanban_image_fill w-100 d-flex align-items-center justify-content-center bg-light" >
                                                        <i class="fa fa-user fa-3x text-muted" title="Codeudor"/>
                                                    </div>
                                                </aside>
                                                <main class="ps-2 ps-md-0">
                                                    <field name="name" invisible="not name" class="fw-bold"/>
                                                    <div t-if="record.relationship.raw_value or record.age.raw_value" class="text-muted">
                                                        <span t-if="record.relationship.raw_value">
                                                            <i class="fa fa-fw me-1 fa-users text-primary" title="Parentesco"/>
                                                            <field name="relationship"/>
                                                        </span>
                                                        <span t-if="record.relationship.raw_value and record.age.raw_value"> - </span>
                                                        <span t-if="record.age.raw_value">
                                                            <i class="fa fa-fw me-1 fa-birthday-cake text-warning" title="Edad"/>
                                                            <field name="age"/> años
                                                        </span>
                                                    </div>
                                                    <div t-if="record.vat.raw_value" class="text-truncate">
                                                        <i class="fa fa-fw me-1 fa-id-card-o text-info" title="Documento"/>
                                                        <field name="vat"/>
                                                    </div>
                                                    <div t-if="record.phone.raw_value">
                                                        <i class="fa fa-fw me-1 fa-phone text-success" title="Teléfono"/>
                                                        <field name="phone"/>
                                                    </div>
                                                    <div t-if="record.email.raw_value" class="text-truncate">
                                                        <i class="fa fa-fw me-1 fa-envelope text-primary" title="Email"/>
                                                        <field name="email"/>
                                                    </div>
                                                    <div t-if="record.residence_address.raw_value" class="text-truncate">
                                                        <i class="fa fa-fw me-1 fa-map-marker text-danger" title="Dirección"/>
                                                        <field name="residence_address"/>, <field name="residence_municipality"/>
                                                    </div>
                                                </main>
                                            </t>
                                        </templates>
                                    </kanban>
                                </field>
                            </page>

                            <page string="Información del Negocio">
                                <group>
                                    <field name="business_name" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    <field name="business_city" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    <field name="business_years_of_activity" readonly="state in ['approved', 'rejected', 'finished']"/>
                                </group>

                                <div class="p-2 mt-4 border border-info rounded" style="background-color:#0a5f6f54;">
                                    <div class="d-flex align-items-center">
                                        <i class="fa fa-info-circle me-2 text-info" title="Información importante"></i>
                                        <span class="text-info">
                                        Recuerde cargar las imágenes del negocio en la pestaña de <strong>Anexos</strong>, como adjunto al cliente.
                                        </span>
                                    </div>
                                </div>
                            </page>

                            <page string="Propuesta Comercial">
                                <group col="2" string="Cupos Sugeridos por el Asesor">
                                    <group>
                                        <field name="suggestion_normal_credit_quota" widget="money" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    </group>
                                    <group>
                                        <field name="suggestion_golden_credit_quota" widget="money" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    </group>
                                </group>
                                <group string="Concepto Comercial">
                                    <field name="good_points" widget="text" placeholder="Describa los puntos a favor que observa en el cliente" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    <field name="bad_points" widget="text" placeholder="Describa los puntos en contra que observa en el cliente" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    <field name="new_points" widget="text" placeholder="Describa las novedades que observa en el cliente" readonly="state in ['approved', 'rejected', 'finished']"/>
                                </group>
                            </page>
                            
                            <page string="Cartera">
                                <div class="p-3 mb-3 border border-warning rounded" style="background-color:#ffc30078;" invisible="arrears_amount_debt == 0">
                                    <div class="d-flex align-items-center">
                                        <i class="fa fa-warning me-2 text-warning" title="Advertencia de cartera"/>
                                        <span>
                                            <strong class="text-warning">Atención:</strong> Este cliente presenta deuda en mora superior a 30 días.
                                            Revisar historial crediticio antes de aprobar.
                                        </span>
                                    </div>
                                </div>
                                
                                <group col="2">
                                    <group string="Compras afectadas por el Cliente">
                                        <field name="total_purchased_this_year" widget="money" help="Es el monto de compras que el cliente ha realizado en el año actual" readonly="1"/>
                                        <field name="total_purchased_last_year" widget="money" help="Es el monto de compras que el cliente ha realizado en el año pasado" readonly="1"/>
                                        <field name="total_purchased_last_two_years" widget="money" help="Es el monto de compras que el cliente ha realizado hace dos años pasados" readonly="1"/>
                                        <field name="total_purchased_last_three_years" widget="money" help="Es el monto de compras que el cliente ha realizado hace tres años pasados" readonly="1"/>
                                    </group>
                                    <group string="Antecedentes del Cliente en la Compañía">
                                        <field name="taked_discount" help="Si el cliente ha tomado descuentos en la compañía" readonly="state in ['approved', 'rejected', 'finished']"/>
                                        <field name="average_days_to_pay" help="Es el promedio de días que toma el cliente para pagar las facturas" readonly="1"/>
                                        <field name="normal_amount_debt" widget="money" readonly="1"/>
                                        <field name="arrears_amount_debt" widget="money" help="Es el monto de deuda que esta fuera de los 30 días despues de la fecha establecida en la condición de pago" readonly="1"/>
                                    </group>
                                </group>

                                <group string="Observaciones, Acuerdos, Moras, etc.">
                                    <field name="cartera_observations" widget="text" placeholder="Describa las observaciones del area de Cartera" readonly="state in ['approved', 'rejected', 'finished']"/>
                                </group>
                            </page>

                            <page string="Auditoría">

                                <group string="Estado de Revisión por Auditoría" col="2">
                                    <group>
                                        <field name="review_auditoria_state" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    </group>
                                    <group>
                                        <field name="rejeaction_auditoria_observations" widget="text" readonly="state in ['approved', 'rejected', 'finished']" invisible="review_auditoria_state != 'rejected'"/>
                                    </group>
                                </group>
                                
                                <group col="2">
                                    <group string="Revisión en la CIFIN">
                                        <field name="audit_is_reported_cifin" help="¿El cliente fue reportado en la CIFIN?" readonly="state in ['approved', 'rejected', 'finished']"/>
                                        <field name="audit_is_late" help="¿El cliente tiene deuda en mora?" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    </group>
                                    <group string="Deudas y Mora en la CIFIN">
                                        <field name="audit_debt_cifin" widget="money" help="Es el monto de deudas que el cliente tiene en la CIFIN" readonly="state in ['approved', 'rejected', 'finished']"/>
                                        <field name="audit_total_late_payment" widget="money" help="Es el monto de mora que el cliente tiene en la CIFIN" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    </group>
                                </group>

                                <group string="Observaciones sobre la Auditoría">
                                    <field name="audit_cifin_observations" widget="text" placeholder="Describa las observaciones de la Auditoría sobre la CIFIN" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    <field name="audit_ctl_observations" widget="text" placeholder="Describa las observaciones de la Auditoría sobre el CTL" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    <field name="audit_observations" widget="text" placeholder="Describa las observaciones generales de la Auditoría" readonly="state in ['approved', 'rejected', 'finished']"/>
                                </group>
                            </page>

                            <page string="Cupos Finales">
                                <group col="2">
                                    <group string="Cupos Finales">
                                        <field name="final_normal_credit_quota" widget="money" help="Es el cupo normal final" readonly="state in ['approved', 'rejected', 'finished']"/>
                                        <field name="final_golden_credit_quota" widget="money" help="Es el cupo dorado final" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    </group>
                                    <group string="Fechas del Cupo">
                                        <field name="credit_quota_start_date" readonly="state in ['approved', 'rejected', 'finished']"/>
                                        <field name="credit_quota_end_date" />
                                    </group>
                                    <group string="Condiciones de Pago">
                                        <field name="property_payment_term_id" readonly="state in ['approved', 'rejected', 'finished']"/>
                                    </group>
                                    <group string="Quien aprueba">
                                        <field name="approved_by" readonly="1"/>
                                        <field name="approved_date" readonly="1"/>
                                    </group>
                                </group>
                                <group string="Observaciones Finales">
                                    <field name="approved_observations" widget="text" readonly="state in ['approved', 'rejected', 'finished']"/>
                                </group>
                            </page>

                            <page string="Anexos">
                                <field name="related_partner_ids" invisible="1"/>
                                <div class="mb-3">
                                    <button name="action_open_documents" type="object" class="btn btn-primary" invisible="state in ['approved', 'rejected', 'finished']">
                                        <i class="fa fa-plus"/> Agregar Documento
                                    </button>
                                </div>
                                <field name="document_ids" nolabel="1" widget="many2many">
                                    <list string="Documentos" create="false" delete="false" expand="1" default_group_by="partner_id">
                                        <field name="partner_id" string="Relacionado con"/>
                                        <field name="name" string="Nombre del Archivo"/>
                                        <field name="attachment_name" string="Nombre del Archivo" optional="hide"/>
                                        <field name="mimetype" string="Tipo" optional="hide"/>
                                        <field name="file_size" string="Tamaño" widget="document_size" optional="hide"/>
                                        <field name="tag_ids" string="Tipo" widget="many2many_tags" options="{'color_field': 'color'}"/>
                                        <field name="create_date" string="Fecha de Creación" optional="hide"/>
                                        <button name="access_content" string="Ver/Descargar" type="object" icon="fa-download"/>
                                    </list>
                                </field>
                            </page>

                            <page string="Histórico">
                                <div class="alert alert-info" role="alert">
                                    <i class="fa fa-info-circle"/> Solicitudes de cupo de crédito anteriores del cliente.
                                </div>
                                <field name="customer_previous_applications" nolabel="1" readonly="1" domain="[('customer_id', '=', customer_id), ('id', '!=', id)]">
                                    <list string="Solicitudes Previas" create="false" delete="false" edit="false" default_order="application_date desc">
                                        <field name="name" string="Solicitud"/>
                                        <field name="subject" string="Asunto"/>
                                        <field name="state" widget="badge" decoration-success="state == 'approved'" decoration-danger="state == 'rejected'" decoration-muted="state == 'finished'"/>
                                        <field name="approved_date" string="Fecha Aprobación"/>
                                        <field name="credit_quota_end_date" string="Vencimiento"/>
                                        <field name="final_normal_credit_quota" string="Cupo Normal" widget="monetary"/>
                                        <field name="final_golden_credit_quota" string="Cupo Dorado" widget="monetary"/>
                                    </list>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter open_attachments="True" reload_on_attachment="True"/>
                </form>
            </field>
        </record>

        <record id="view_sale_credit_quota_application_list" model="ir.ui.view">
            <field name="name">sale.credit.quota.application.list</field>
            <field name="model">sale.credit.quota.application</field>
            <field name="arch" type="xml">
                <list string="Solicitudes de Cupo">
                    <field name="name" string="Solicitud" />
                    <field name="customer_id" string="Cliente" />
                    <field name="subject" />
                    <field name="branch_office" />
                    <field name="state" widget="badge" decoration-success="state == 'approved'" decoration-danger="state == 'rejected'" decoration-muted="state == 'finished'" />
                    <field name="application_date" />
                    <field name="user_id" />
                    <field name="credit_quota_end_date" invisible="1" />
                </list>
            </field>
        </record>

        <record id="view_sale_credit_quota_application_search" model="ir.ui.view">
            <field name="name">sale.credit.quota.application.search</field>
            <field name="model">sale.credit.quota.application</field>
            <field name="arch" type="xml">
                <search string="Buscar Solicitudes de Cupo">
                    <field name="name"/>
                    <field name="customer_id"/>
                    <field name="subject"/>
                    <field name="branch_office"/>
                    <field name="state"/>
                    <field name="application_date"/>
                    <field name="credit_quota_end_date"/>
                    <field name="user_id"/>
                    
                    <filter string="Borrador" name="filter_draft" domain="[('state', '=', 'draft')]"/>
                    <filter string="Aprobadas" name="filter_approved" domain="[('state', '=', 'approved')]"/>
                    <filter string="Finalizadas" name="filter_finished" domain="[('state', '=', 'finished')]"/>
                    <filter string="Rechazadas" name="filter_rejected" domain="[('state', '=', 'rejected')]"/>
                    
                    <separator/>
                    <filter string="Pendientes de Aprobación" name="filter_pending_approval" domain="[('review_auditoria_state', '!=', 'approved'), ('state', '=', 'draft')]"/>
                    
                    <separator/>
                    <filter name="group_by_state" string="Estado" context="{'group_by': 'state'}"/>
                    <filter name="group_by_branch" string="Sucursal" context="{'group_by': 'branch_office'}"/>
                    <filter name="group_by_subject" string="Asunto" context="{'group_by': 'subject'}"/>
                    <filter name="group_by_user" string="Asesor" context="{'group_by': 'user_id'}"/>
                    <filter name="group_by_customer" string="Cliente" context="{'group_by': 'customer_id'}"/>
                </search>
            </field>
        </record>

        <record id="sale_credit_quota_application_action" model="ir.actions.act_window">
            <field name="name">Solicitudes de Cupo</field>
            <field name="res_model">sale.credit.quota.application</field>
            <field name="view_mode">list,form,search</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    ¡Crea tu primera solicitud de cupo de crédito!
                </p>
                <p>
                    Las solicitudes de cupo de crédito te permiten tener trazabilidad de las solicitudes de cupo de los clientes.
                </p>
                <p>
                    Puedes crear una solicitud de cupo de crédito para un cliente específico.
                </p>
            </field>
        </record>

        
    </data>
</odoo>