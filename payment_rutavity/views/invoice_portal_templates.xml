<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Add checkboxes and bulk payment functionality to invoice list -->
    <template id="portal_my_invoices_bulk_payment" inherit_id="account.portal_my_invoices">
       
        <!-- Add bulk payment summary bar -->
        <xpath expr="//t[@t-if='not invoices']" position="before">
            <div t-if="invoices" class="mb-3 o_invoice_bulk_controls">
                <!-- Bulk payment summary (hidden by default, shown when invoices selected) -->
                <div id="bulk_payment_summary" class="d-none rounded-3">
                    <div class="alert alert-light border-0 mb-0 ">
                        <div class="d-flex justify-content-between align-items-center gap-3">
                            <!-- Left side: Total amount -->
                            <div class="text-center">
                                <span class="text-muted small">Total to pay</span>
                                <div class="fw-bold fs-5">
                                    <span id="bulk_total_amount" class="text-nowrap"></span>
                                </div>
                            </div>
                            
                            <!-- Right side: Action button -->
                            <div>
                                <button type="button" id="proceed_bulk_payment_btn"
                                    class="btn btn-primary d-flex align-items-center gap-2">
                                    <span>Go to payment</span>
                                    <i class="fa fa-arrow-circle-right"/>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </xpath>
        
        <!-- Add checkbox column header at the beginning -->
        <xpath expr="//thead/tr[hasclass('active')]/th[1]" position="before">
            <th class="bulk-selection-header" style="width: 50px;">
                <input type="checkbox" id="select_all_invoices" class="form-check-input" title="Select All"/>
            </th>
        </xpath>
        
        <!-- Add checkbox to each invoice row at the beginning -->
        <xpath expr="//t[@t-foreach='invoices']/tr/td[1]" position="before">
            <td class="bulk-selection-cell">
                <t t-set="invoice" t-value="invoice_data['invoice']"/>
                <input t-if="invoice._has_to_be_paid()"
                    type="checkbox" 
                    name="invoice_checkbox"
                    t-att-value="invoice.id"
                    t-att-data-amount="invoice.amount_residual"
                    t-att-data-currency-id="invoice.currency_id.id"
                    t-att-data-currency-symbol="invoice.currency_id.symbol"
                    class="form-check-input invoice-checkbox"/>
            </td>
        </xpath>
    </template>

    <!-- Extend overdue invoices payment page to add invoice cards with editable amounts -->
    <template id="portal_selected_invoices_payment_page" name="Selected Invoices Payment" inherit_id="account_payment.portal_overdue_invoices_page">
        <xpath expr="//div[hasclass('col-lg-7')]" position="attributes">
            <attribute name="class" remove="col-lg-7"/>
            <attribute name="class" add="col" separator=" "/>
            <attribute name="class" add="rutavity-payment-page" separator=" "/>
        </xpath>
        
        <!-- Replace the summary with our custom invoice cards -->
        <xpath expr="//div[hasclass('text-bg-light')]" position="replace">
            <!-- Title with proper i18n support -->
            <h3 class="mb-4 text-center" t-out="page_title"/>
        
            <!-- Selected Invoices Summary with Editable Amounts (Card Design) -->
            <div class="mb-4">
                <!-- Invoices Container -->
                <div id="invoices_payment_card" class="invoices-grid mb-3">
                    <t t-foreach="invoices" t-as="invoice">
                        <t t-set="installment_state" t-value="invoice._get_invoice_next_payment_values().get('installment_state')"/>
                        <t t-set="amount_due" t-value="invoice._get_invoice_next_payment_values().get('amount_due')"/>
                        <t t-set="next_amount_to_pay" t-value="invoice._get_invoice_next_payment_values().get('next_amount_to_pay')"/>
                        <t t-set="has_installments" t-value="installment_state in ('next', 'overdue') and amount_due != next_amount_to_pay"/>
                        <div>
                            <div class="card invoice-card shadow-sm h-100" t-att-data-invoice-id="invoice.id">
                                <div class="card-body d-flex flex-column">
                                    <!-- Header Row: Invoice ID and Balance Due -->
                                    <div class="row mb-2">
                                        <div class="col-6">
                                            <small class="text-muted d-block">Invoice</small>
                                            <strong class="d-block text-nowrap" t-out="invoice.name"/>
                                        </div>
                                        <div class="col-6 text-end">
                                            <small class="text-muted d-block">Balance Due</small>
                                            <span class="text-primary fw-bold" 
                                                    t-out="amount_due" 
                                                    t-options="{'widget': 'monetary', 'display_currency': invoice.currency_id}"/>
                                        </div>
                                    </div>
                                    
                                    <!-- Customer Name Row -->
                                    <div class="row mb-3">
                                        <div class="col-12">
                                            <small class="text-muted d-block">Customer</small>
                                            <span class="d-block" t-out="invoice.partner_id.anonymized_name if logged_partner and logged_partner.id != invoice.partner_id.id else invoice.partner_id.name"/>
                                        </div>
                                    </div>
                                    
                                    <!-- Payment Options: Installment vs Full Payment -->
                                    
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <div class="payment-options-container">
                                                <label class="form-label small text-muted mb-1 d-flex align-items-center">
                                                    <i class="fa fa-clock-o me-1"/>
                                                    <span>Quick select</span>
                                                </label>
                                                <div class="payment-options-selector d-flex gap-2 w-100 justify-content-center p-1">
                                                    <t t-if="has_installments">
                                                        <input type="radio" 
                                                            class="btn-check payment-option-radio d-none" 
                                                            t-att-name="'payment_option_' + str(invoice.id)"
                                                            t-att-id="'installment_opt_' + str(invoice.id)"
                                                            t-att-data-invoice-id="invoice.id"
                                                            t-att-data-amount="next_amount_to_pay"
                                                            checked="checked"
                                                        />
                                                        <label class="payment-option-label d-flex flex-column flex-sm-row align-items-center justify-content-center gap-1 gap-sm-2" t-att-for="'installment_opt_' + str(invoice.id)">
                                                            <span class="option-text">Installment</span>
                                                            <span class="option-amount" t-out="next_amount_to_pay" 
                                                                t-options="{'widget': 'monetary', 'display_currency': invoice.currency_id}"/>
                                                        </label>
                                                    </t>
                                                    <input type="radio" 
                                                        class="btn-check payment-option-radio" 
                                                        t-att-name="'payment_option_' + str(invoice.id)"
                                                        t-att-id="'full_opt_' + str(invoice.id)"
                                                        t-att-data-invoice-id="invoice.id"
                                                        t-att-data-amount="amount_due"
                                                    />
                                                    <label class="payment-option-label d-flex flex-column flex-sm-row align-items-center justify-content-center gap-1 gap-sm-2" t-att-for="'full_opt_' + str(invoice.id)">
                                                        <span class="option-text">Total</span>
                                                        <span class="option-amount" t-out="amount_due" 
                                                            t-options="{'widget': 'monetary', 'display_currency': invoice.currency_id}"/>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Spacer to push input to bottom -->
                                    <div class="flex-grow-1"></div>
                                    
                                    <!-- Amount to Pay Input (always visible and editable) -->
                                    <div class="row mt-auto">
                                        <div class="col-12 text-center">
                                            <label class="form-label small text-muted mb-1">
                                                <i class="fa fa-pencil me-1"/>Amount to Pay
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light" t-out="invoice.currency_id.symbol"/>
                                                <input 
                                                    type="number" 
                                                    class="form-control form-control-lg fw-bold invoice-amount-input text-center"
                                                    t-att-name="'amount_' + str(invoice.id)"
                                                    t-att-data-invoice-id="invoice.id"
                                                    t-att-data-max-amount="amount_due"
                                                    t-att-data-currency-id="invoice.currency_id.id"
                                                    t-att-value="has_installments and next_amount_to_pay or amount_due"
                                                    step="0.01"
                                                    min="0.01"
                                                    placeholder="0.00"
                                                    required="required"/>
                                            </div>
                                            <small class="text-danger d-none invalid-amount-msg mt-1 d-block">
                                                <i class="fa fa-exclamation-triangle me-1"/>
                                                Amount must be between 0.01 and <span class="max-amount-display"/>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </div>
                
                <!-- Total Summary Card -->
                <div class="card border-primary shadow-sm">
                    <div class="card-body bg-light">
                        <div class="row align-items-center">
                            <div class="col-12 col-md-6 text-center text-md-start">
                                <h6 class="mb-0 text-muted">Total to pay</h6>
                            </div>
                            <div class="col-12 col-md-6 text-center text-md-end">
                                <div class="d-flex justify-content-center justify-content-md-end align-items-center gap-2 fs-4 fw-bold text-primary">
                                    <span id="payment_total_currency" class="d-none" t-out="currency.symbol"/>
                                    <span id="payment_total_amount" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </xpath>
    </template>

    <!-- Public invoice search page -->
    <template id="portal_invoice_search_page" name="Invoice Search Page">
        <t t-call="portal.frontend_layout">
            <t t-set="additional_title" t-value="page_title"/>
            
            <div class="container my-5">
                <div class="row justify-content-center">
                    <div class="col-lg-8 col-xl-6">
                        <!-- Header -->
                        <div class="text-center mb-4">
                            <h1 class="display-6 fw-bold text-primary">
                                <i class="fa fa-search me-2"/>
                                <t t-out="page_title"/>
                            </h1>
                            <p class="text-muted lead">
                                Enter your invoice numbers to search and pay
                            </p>
                        </div>

                        <!-- Search Form Card -->
                        <div class="mb-4">
                            <form id="invoice_search_form" class="needs-validation" novalidate="true">
                                <!-- Invoice Numbers -->
                                <div class="mb-3">
                                    <label for="invoice_numbers" class="form-label">
                                        <i class="fa fa-file-text-o me-1"/>
                                        Invoice Numbers <span class="text-danger">*</span>
                                    </label>
                                    <textarea 
                                        class="form-control font-monospace" 
                                        id="invoice_numbers"
                                        name="invoice_numbers"
                                        rows="2"
                                        placeholder="100120039, 100120040, 100120041"
                                        required="true"></textarea>
                                    <div class="form-text">
                                        You can enter multiple invoice numbers separated by commas. Example: 100120039, 100120040, 100120041.
                                    </div>
                                    <div class="invalid-feedback">
                                        Please enter at least one invoice number
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <button type="submit" class="btn btn-primary btn-md mx-auto d-flex align-items-center justify-content-center gap-2" id="search_btn">
                                    <i class="fa fa-search"/>
                                    <span>Search</span>
                                </button>
                            </form>
                        </div>

                        <!-- Loading Spinner -->
                        <div id="loading_spinner" class="text-center d-none mb-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Searching invoices...</p>
                        </div>

                        <!-- Results Container -->
                        <div id="results_container" class="d-none">
                            <!-- Invoices Table -->
                            <div class="card shadow-sm border-0 mb-4">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0 text-center">
                                        <i class="fa fa-list-alt me-2"/>
                                        Invoices Found
                                    </h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0" id="invoices_table">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Invoice Number</th>
                                                    <th class="text-end">Amount Due</th>
                                                </tr>
                                            </thead>
                                            <tbody id="invoices_table_body">
                                                <!-- Populated by JS -->
                                            </tbody>
                                            <tfoot class="table-light">
                                                <tr>
                                                    <td class="fw-bold">Total to Pay</td>
                                                    <td class="text-end fw-bold" id="total_amount_cell">-</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Button -->
                            <div class="d-grid gap-2">
                                <a id="proceed_to_payment_btn" href="#" class="btn btn-success btn-md d-flex align-items-center justify-content-center gap-2">
                                    <i class="fa fa-credit-card"/>
                                    <span>Proceed to Payment</span>
                                </a>
                            </div>
                        </div>

                        <!-- Info Card -->
                        <div class="card bg-light border-0 mt-4">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fa fa-info-circle me-1"/>
                                    How it works
                                </h6>
                                <ul class="mb-0 small">
                                    <li>Enter your invoice numbers (separate with commas)</li>
                                    <li>Review the invoices found</li>
                                    <li>Proceed to payment with your preferred method</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

</odoo>

