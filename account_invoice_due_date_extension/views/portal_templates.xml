<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Sobrescribir el badge de estado de factura -->
    <template id="invoice_status_badge_extension" 
              name="Invoice Status Badge with Extension" 
              inherit_id="portal_invoice_partner_grouping.invoice_status_badge">
        
        <!-- Reemplazar la lógica de is_overdue para usar effective_due_date -->
        <xpath expr="//t[@t-set='is_overdue']" position="replace">
            <!-- Usar effective_due_date si existe, sino invoice_date_due -->
            <t t-set="due_date_to_check" t-value="invoice.effective_due_date or invoice.invoice_date_due"/>
            <t t-set="is_overdue" t-value="due_date_to_check and due_date_to_check &lt; datetime.date.today()"/>
        </xpath>
    </template>
    
    <!-- Sobrescribir la tarjeta mobile de facturas -->
    <template id="invoice_card_mobile_extension" 
              name="Invoice Card Mobile with Extension" 
              inherit_id="portal_invoice_partner_grouping.invoice_card_mobile">
        
        <!-- Reemplazar la variable is_overdue en el inicio de la tarjeta -->
        <xpath expr="//t[@t-set='is_overdue']" position="replace">
            <!-- Usar effective_due_date si existe, sino invoice_date_due -->
            <t t-set="due_date_to_check" t-value="invoice.effective_due_date or invoice.invoice_date_due"/>
            <t t-set="is_overdue" t-value="due_date_to_check and due_date_to_check &lt; datetime.date.today()"/>
        </xpath>
        
        <!-- Reemplazar el campo que muestra la fecha de vencimiento -->
        <xpath expr="//span[@t-field='invoice.invoice_date_due']" position="replace">
            <!-- Mostrar effective_due_date si existe, sino invoice_date_due -->
            <t t-if="invoice.effective_due_date">
                <span t-field="invoice.effective_due_date"/>
                <!-- Indicador visual de que tiene prórroga -->
                <t t-if="invoice.extended_due_date">
                    <i class="fa fa-calendar-plus-o ms-1 text-warning" 
                       title="Esta factura tiene una prórroga aprobada" 
                       aria-label="Extended"/>
                </t>
            </t>
            <t t-else="">
                <span t-field="invoice.invoice_date_due"/>
            </t>
        </xpath>
        
        <!-- Reemplazar el cálculo de días vencidos para usar effective_due_date -->
        <xpath expr="//t[@t-set='days_overdue']" position="replace">
            <t t-set="days_overdue" t-value="(datetime.date.today() - due_date_to_check).days"/>
        </xpath>
    </template>

    
    <!-- Agregar columna de prórroga reemplazando el header de Due Date -->
    <template id="portal_my_invoices_table_header_extension"
              name="Add Extension Column Header"
              inherit_id="portal_invoice_partner_grouping.portal_my_invoices_grouped">
        
        <!-- Reemplazar el header de "Due Date" para agregar la columna de prórroga después -->
        <xpath expr="//th[@name='due_date']" position="replace">
            <th name="due_date" class='d-none d-md-table-cell'>Due Date</th>
            <th name="extended_due_date" class='d-none d-md-table-cell text-center'>
                <span>Prórroga</span>
            </th>
        </xpath>
        
        <!-- Reemplazar TODAS las celdas de fecha de vencimiento para usar effective_due_date -->
        <xpath expr="//td[.//span[@t-field='invoice.invoice_date_due']]" position="replace">
            <!-- Columna original de Due Date - USA EFFECTIVE_DUE_DATE para determinar si está vencida -->
            <td class='d-none d-md-table-cell'>
                <t t-set="due_date_to_check" t-value="invoice.effective_due_date or invoice.invoice_date_due"/>
                <span t-att-class="'text-danger' if due_date_to_check and due_date_to_check &lt; datetime.date.today() and invoice.payment_state in ['not_paid', 'partial'] else ''"
                      t-field="invoice.invoice_date_due"/>
            </td>
            <!-- Nueva columna de Prórroga -->
            <td name="extended_due_date_cell" class='d-none d-md-table-cell text-center'>
                <t t-if="invoice.extended_due_date">
                    <div class="d-flex flex-column align-items-center">
                        <span t-field="invoice.extended_due_date" class="text-warning fw-bold"/>
                        <small class="text-muted" style="font-size: 0.75rem;">
                            <i class="fa fa-check-circle text-success me-1"/>Aprobada
                        </small>
                    </div>
                </t>
                <t t-else="">
                    <span class="text-muted">-</span>
                </t>
            </td>
        </xpath>
    </template>

</odoo>

