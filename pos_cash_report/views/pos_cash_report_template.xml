<?xml version="1.0" encoding="utf-8"?>
<odoo>
     <!-- Template principal del reporte -->
    <template id="report_cash_closing">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="pos_cash_report.cash_closing_document" t-lang="doc.config_id.company_id.partner_id.lang"/>
            </t>
        </t>
    </template>

    <!-- Template del documento -->
    <template id="cash_closing_document">
        <t t-set="data" t-value="doc.get_report_data()"/>
        <t t-call="web.basic_layout">
            <div class="cash-closing-report">
                <div class="page">
                <!-- Encabezado -->
                <div class="text-center mb-3">
                    <h2 class="report-title"><span class="fw-bold">REPORTE DE CIERRE DE CAJA</span></h2>
                    <p class="datetime-info">
                        <span class="fw-bold">Apertura:</span> <span t-out="data['start_at']" t-options="{'widget': 'datetime'}"/> | 
                        <span class="fw-bold">Cierre:</span> <span t-out="data['stop_at']" t-options="{'widget': 'datetime'}"/>
                    </p>
                </div>

                <div class="general-information">
                    <h5><strong>Información General</strong></h5>
                    <div class="content d-flex flex-row flex-wrap">
                        <p class="mb-1 me-3"><strong>Cajero:</strong> <span t-out="data['user'].name"/></p>
                        <p class="mb-1 me-3"><strong>POS:</strong> <span t-out="data['config'].name"/></p>
                        <p class="mb-0 me-3"><strong>Estado:</strong> <span t-out="data['state_display']"/></p>
                        <p class="me-3"><span class="fw-bold">Sesión:</span> <span t-out="data['session_number']"/><br/></p>
                    </div>

                </div>


                <div class="financial-summary">
                    <h5><strong>Resumen Financiero</strong></h5>
                    <div class="financial-summary-container">
                        <div class="financial-column">
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <td><strong>Ventas:</strong></td>
                                    <td class="text-end">
                                        <span t-out="data['total_sales']" t-options="{'widget': 'float', 'precision': 2}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Gastos:</strong></td>
                                    <td class="text-end">
                                        <span t-out="data['total_expenses']" t-options="{'widget': 'float', 'precision': 2}"/>
                                    </td>
                                </tr>
                                <tr class="border-top">
                                    <td><strong>Efectivo Inicial:</strong></td>
                                    <td class="text-end">
                                        <span t-out="data['cash_box_start']" t-options="{'widget': 'float', 'precision': 2}"/>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="financial-column">
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <td><strong>Efectivo Esperado:</strong></td>
                                    <td class="text-end">
                                        <span t-out="data['cash_box_end_expected']" t-options="{'widget': 'float', 'precision': 2}"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Efectivo Contado:</strong></td>
                                    <td class="text-end">
                                        <span t-out="data['cash_box_end_real']" t-options="{'widget': 'float', 'precision': 2}"/>
                                    </td>
                                </tr>
                                <tr class="border-top">
                                    <td><strong>Diferencia:</strong></td>
                                    <td class="text-end">
                                        <span t-out="data['difference']" 
                                                t-options="{'widget': 'float', 'precision': 2}"
                                                t-attf-class="#{data['has_difference'] and 'text-danger fw-bold' or ''}"/>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
             
                <!-- Métodos de Pago -->
                <div class="mb-4">
                    <h5><strong>Métodos de Pago</strong></h5>
                    <t t-if="data['has_payment_methods']">
                        <table class="table table-sm table-striped payment-methods-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Método de Pago</th>
                                    <th class="text-center">Cantidad de Transacciones</th>
                                    <th class="text-end">Monto Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="data['payment_methods']" t-as="method">
                                    <tr>
                                        <td><strong t-out="method['name']"/></td>
                                        <td class="text-center"><span t-out="method['count']"/></td>
                                        <td class="text-end">
                                            <span t-out="method['total']" t-options="{'widget': 'float', 'precision': 2}"/>
                                        </td>
                                    </tr>
                                </t>
                                <tr class="fw-bold">
                                    <td><strong>TOTAL</strong></td>
                                    <td class="text-center"><span t-out="data['payment_methods_totals']['count']"/></td>
                                    <td class="text-end">
                                        <span t-out="data['payment_methods_totals']['amount']" t-options="{'widget': 'float', 'precision': 2}"/>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </t>
                    <t t-else="">
                        <p class="text-muted">No hay métodos de pago registrados.</p>
                    </t>
                </div>

                <!-- Desglose por Denominaciones -->
                <t t-if="data['cash_control_enabled']">
                    <div class="mb-4 denominations-section">
                        <h5><strong>Denominaciones</strong></h5>
                        <t t-if="data['has_denominations']">
                            <div class="denominations-container">
                                <!-- Tabla de Billetes -->
                                <div class="denominations-column">
                                    <t t-if="data['denominations']['bills']">
                                        <table class="table table-sm table-striped denominations-table">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Denominación</th>
                                                    <th class="text-center">Cantidad</th>
                                                    <th class="text-end">Subtotal</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="data['denominations']['bills']" t-as="denom">
                                                    <tr>
                                                        <td><strong t-out="denom['formatted_value']"/></td>
                                                        <td class="text-center"><span t-out="denom['count']"/></td>
                                                        <td class="text-end">
                                                            <span t-out="denom['total']" t-options="{'widget': 'float', 'precision': 2}"/>
                                                        </td>
                                                    </tr>
                                                </t>
                                                <tr class="table-secondary fw-bold">
                                                    <td><strong>TOTAL BILLETES</strong></td>
                                                    <td class="text-center"><span t-out="data['denominations_totals']['bills']['count']"/></td>
                                                    <td class="text-end">
                                                        <span t-out="data['denominations_totals']['bills']['total']" t-options="{'widget': 'float', 'precision': 2}"/>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted">No hay billetes registrados.</p>
                                    </t>
                                </div>
                                
                                <!-- Tabla de Monedas -->
                                <div class="denominations-column">
                                    <t t-if="data['denominations']['coins']">
                                        <table class="table table-sm table-striped denominations-table">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Denominación</th>
                                                    <th class="text-center">Cantidad</th>
                                                    <th class="text-end">Subtotal</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="data['denominations']['coins']" t-as="denom">
                                                    <tr>
                                                        <td><strong t-out="denom['formatted_value']"/></td>
                                                        <td class="text-center"><span t-out="denom['count']"/></td>
                                                        <td class="text-end">
                                                            <span t-out="denom['total']" t-options="{'widget': 'float', 'precision': 2}"/>
                                                        </td>
                                                    </tr>
                                                </t>
                                                <tr class="table-secondary fw-bold">
                                                    <td><strong>TOTAL MONEDAS</strong></td>
                                                    <td class="text-center"><span t-out="data['denominations_totals']['coins']['count']"/></td>
                                                    <td class="text-end">
                                                        <span t-out="data['denominations_totals']['coins']['total']" t-options="{'widget': 'float', 'precision': 2}"/>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </t>
                                    <t t-else="">
                                        <p class="text-muted">No hay monedas registradas.</p>
                                    </t>
                                </div>
                            </div>
                            
                            <!-- Total General -->
                            <div class="total-general-container">
                                <div class="alert alert-info">
                                    <h6 class="mb-0">
                                        <strong>TOTAL EFECTIVO CONTADO: 
                                            <span t-out="data['denominations_totals']['grand_total']" t-options="{'widget': 'float', 'precision': 2}"/>
                                        </strong>
                                    </h6>
                                </div>
                            </div>
                        </t>
                        <t t-else="">
                            <p class="text-muted">No se encontraron denominaciones detalladas en las notas de cierre.</p>
                        </t>
                    </div>
                </t>

                <!-- Desglose de Efectivo -->
                <t t-if="data['cash_control_enabled']">
                    <div class="mb-4">
                        <h5><strong>Movimientos</strong></h5>
                        <t t-if="data['cash_movements']['has_movements']">
                            <table class="table table-sm table-striped cash-movements-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Descripción</th>
                                        <th class="text-center">Fecha</th>
                                        <th class="text-end">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="data['cash_movements']['lines']" t-as="line">
                                        <tr>
                                            <td><span t-out="line['description']"/></td>
                                            <td class="text-center"><span t-out="line['date']" t-options="{'widget': 'date'}"/></td>
                                            <td class="text-end">
                                                <span t-out="line['amount']" 
                                                        t-options="{'widget': 'float', 'precision': 2}"
                                                        t-attf-class="#{line['is_negative'] and 'text-danger' or 'text-success'}"/>
                                            </td>
                                        </tr>
                                    </t>
                                    <tr class="table-secondary fw-bold">
                                        <td><strong>TOTAL MOVIMIENTOS</strong></td>
                                        <td></td>
                                        <td class="text-end">
                                            <span t-out="data['cash_movements']['total']" 
                                                    t-options="{'widget': 'float', 'precision': 2}"
                                                    t-attf-class="#{data['cash_movements']['total'] &lt; 0 and 'text-danger' or 'text-success'}"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </t>
                        <t t-else="">
                            <p class="text-muted">No hay movimientos de efectivo registrados.</p>
                        </t>
                    </div>
                </t>

                <!-- Órdenes de la sesión -->
                <div class="mb-4">
                    <h5><strong>Órdenes</strong></h5>
                    <table class="table table-sm table-borderless summary-orders-table">
                        <tr>
                            <td><strong>Total de Órdenes:</strong></td>
                            <td t-out="data['orders']['paid_count']"/>
                        </tr>
                        <tr>
                            <td><strong>Órdenes Canceladas:</strong></td>
                            <td t-out="data['orders']['cancelled_count']"/>
                        </tr>
                    </table>
                </div>

                <!-- Sección de Firmas -->
                <div class="signatures-section mt-5 pt-4">
                    <div class="row">
                        <div class="col-6">
                            <div class="signature-item">
                                <p class="mb-1"><strong>Firma Dac:</strong></p>
                                <div class="signature-line"></div>
                            </div>
                            <div class="signature-item">
                                <p class="mb-1"><strong>Firma Aux. Contable:</strong></p>
                                <div class="signature-line"></div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="signature-item">
                                <p class="mb-1"><strong>Firma Cajero:</strong></p>
                                <div class="signature-line"></div>
                            </div>
                            <div class="signature-item">
                                <p class="mb-1"><strong>Firma Auditor:</strong></p>
                                <div class="signature-line"></div>
                            </div>
                        </div>
                    </div>
                </div>

                </div>
            </div>
        </t>
    </template>
</odoo>