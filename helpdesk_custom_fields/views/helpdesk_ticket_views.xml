<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="helpdesk_ticket_view_form" model="ir.ui.view">
        <field name="name">helpdesk.ticket.view.form</field>
        <field name="model">helpdesk.ticket</field>
        <field name="inherit_id" ref="helpdesk.helpdesk_ticket_view_form" />
        <field name="arch" type="xml">

            <xpath expr="//div[hasclass('oe_button_box')]" position="inside">
                <button name="action_print_warranty_certificate" 
                        string="Imprimir Acta" 
                        type="object" 
                        class="btn-primary"
                        invisible="not is_warranty_team"
                        icon="fa-print"/>
            </xpath>

            <xpath expr="//field[@name='user_id']" position="after">
                <label for="serie" string="Serie" invisible="not is_warranty_team" class="o_form_label" required="is_warranty_team"/>
                <div class="o_row" invisible="not is_warranty_team">
                    <field name="serie" placeholder="Seleccione serie" required="is_warranty_team"/>
                    <span class="mx-2">#</span>
                    <field name="consecutive_number" readonly="1" placeholder="0"/>
                </div>
            </xpath>

            <xpath expr="//field[@name='tag_ids']" position="after">
                <field name="branch_id" invisible="not is_warranty_team"/>
                <field name="origin" invisible="not is_warranty_team"/>
                <field name="create_date" invisible="not is_warranty_team" string="Fecha de inicio"/>
                <field name="date_closed" invisible="not is_warranty_team"/>
            </xpath>

            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="card_code" invisible="not is_warranty_team"/>
                <field name="client_type" invisible="not is_warranty_team"/>
                <field name="invoice_id" 
                       invisible="not is_warranty_team"
                       required="is_warranty_team"
                       context="{'default_partner_id': partner_id, 'default_move_type': 'out_invoice'}"
                       options="{'no_create': True}"/>
                <field name="available_product_ids" invisible="1"/>
                <field name="product_ids" 
                       invisible="not is_warranty_team or not invoice_id"
                       widget="many2many_tags"
                       domain="[('id', 'in', available_product_ids)]"
                       options="{'no_create': True, 'no_open': True}"/>
            </xpath>

            <xpath expr="//notebook" position="inside">
                <page string="Comentario del área de garantías" name="warranty_comment" invisible="not is_warranty_team">
                    <field name="warranty_comment" placeholder="Observaciones del área de garantías" />
                </page>
                
                <page string="Gestión de Despacho" name="dispatch_management" invisible="not is_warranty_team">
                    <group>
                        <group string="Retorno del artículo al almacén" name="return_column">
                            <field name="has_return"/>
                            <field name="return_dispatch_method" 
                                   invisible="not has_return" 
                                   required="has_return"/>
                            
                            <separator string="Datos de Transportadora" 
                                       invisible="not has_return or return_dispatch_method != 'carrier'"/>
                            
                            <field name="return_carrier_name" 
                                   invisible="not has_return or return_dispatch_method != 'carrier'"
                                   required="has_return and return_dispatch_method == 'carrier'"/>
                            
                            <field name="return_carrier_guide_number" 
                                   invisible="not has_return or return_dispatch_method != 'carrier'"
                                   required="has_return and return_dispatch_method == 'carrier'"/>
                            
                            <field name="return_vehicle_plate" 
                                   invisible="not has_return or return_dispatch_method != 'carrier'"
                                   required="has_return and return_dispatch_method == 'carrier'"/>
                            
                            <field name="return_package_count" 
                                   invisible="not has_return or return_dispatch_method != 'carrier'"
                                   required="has_return and return_dispatch_method == 'carrier'"/>
                            
                            <field name="return_freight_value" 
                                   widget="monetary"
                                   invisible="not has_return or return_dispatch_method != 'carrier'"
                                   required="has_return and return_dispatch_method == 'carrier'"/>
                            
                            <field name="return_declared_merchandise_value" 
                                   widget="monetary"
                                   invisible="not has_return or return_dispatch_method != 'carrier'"
                                   required="has_return and return_dispatch_method == 'carrier'"/>
                        </group>
                        
                        <group string="Despacho al cliente" name="dispatch_column">
                            <field name="is_dispatched"/>
                            <field name="dispatch_method" 
                                   invisible="not is_dispatched" 
                                   required="is_dispatched"/>
                            
                            <separator string="Datos de Transportadora" 
                                       invisible="not is_dispatched or dispatch_method != 'carrier'"/>
                            
                            <field name="carrier_name" 
                                   invisible="not is_dispatched or dispatch_method != 'carrier'"
                                   required="is_dispatched and dispatch_method == 'carrier'"/>
                            
                            <field name="carrier_guide_number" 
                                   invisible="not is_dispatched or dispatch_method != 'carrier'"
                                   required="is_dispatched and dispatch_method == 'carrier'"/>
                            
                            <field name="vehicle_plate" 
                                   invisible="not is_dispatched or dispatch_method != 'carrier'"
                                   required="is_dispatched and dispatch_method == 'carrier'"/>
                            
                            <field name="package_count" 
                                   invisible="not is_dispatched or dispatch_method != 'carrier'"
                                   required="is_dispatched and dispatch_method == 'carrier'"/>
                            
                            <field name="freight_value" 
                                   widget="monetary"
                                   invisible="not is_dispatched or dispatch_method != 'carrier'"
                                   required="is_dispatched and dispatch_method == 'carrier'"/>
                            
                            <field name="declared_merchandise_value" 
                                   widget="monetary"
                                   invisible="not is_dispatched or dispatch_method != 'carrier'"
                                   required="is_dispatched and dispatch_method == 'carrier'"/>
                        </group>
                    </group>
                    <div class="alert alert-warning" 
                         invisible="not is_dispatched or dispatch_method == 'carrier'"
                         role="alert">
                        <p>
                            <strong>Importante:</strong> Si es transportadora, debe de anexar la guía en la pestaña de Anexos.
                        </p>
                    </div>
                </page>
                
                <page string="Anexos" name="attachments">
                    <field name="attachment_ids" 
                           widget="attachment_preview" 
                           string="Subir Anexos"
                           context="{'default_res_model': 'helpdesk.ticket', 'default_res_id': id}"/>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Herencia de la vista kanban para agregar serie y consecutivo -->
    <record id="helpdesk_ticket_view_kanban_inherit" model="ir.ui.view">
        <field name="name">helpdesk.ticket.view.kanban.inherit</field>
        <field name="model">helpdesk.ticket</field>
        <field name="inherit_id" ref="helpdesk.helpdesk_ticket_view_kanban"/>
        <field name="arch" type="xml">
            <xpath expr="//kanban" position="inside">
                <field name="is_warranty_team"/>
                <field name="serie"/>
                <field name="consecutive_number"/>
                <field name="create_date"/>
                <field name="date_closed"/>
            </xpath>

            <xpath expr="//div[hasclass('fw-bold', 'fs-5')]" position="after">
                <div t-if="record.is_warranty_team.raw_value and record.serie.raw_value" class="text-muted">
                    <span t-out="record.serie.value"/> # <span t-out="record.consecutive_number.value"/>
                </div>
                <div t-if="record.is_warranty_team.raw_value and record.create_date.raw_value" class="text-muted small">
                    <i class="fa fa-calendar"/> Inicio: <span t-out="record.create_date.value"/>
                </div>
                <div t-if="record.is_warranty_team.raw_value and record.date_closed.raw_value" class="text-muted small">
                    <i class="fa fa-check-circle"/> Finalizado: <span t-out="record.date_closed.value"/>
                </div>
            </xpath>
        </field>
    </record>

    <!-- Herencia del formulario de creación rápida para agregar serie -->
    <record id="quick_create_ticket_form_inherit" model="ir.ui.view">
        <field name="name">helpdesk.ticket.form.quick_create.inherit</field>
        <field name="model">helpdesk.ticket</field>
        <field name="inherit_id" ref="helpdesk.quick_create_ticket_form"/>
        <field name="arch" type="xml">
            
            <xpath expr="//field[@name='team_id']" position="after">
                <field name="is_warranty_team" invisible="1"/>
            </xpath>

            <xpath expr="//field[@name='partner_id']" position="after">
                <label for="serie" string="Serie" 
                       invisible="not is_warranty_team" 
                       required="is_warranty_team"/>
                <div class="o_row" invisible="not is_warranty_team">
                    <field name="serie" placeholder="Seleccione serie" 
                           required="is_warranty_team"/>
                    <span class="mx-2">#</span>
                    <field name="consecutive_number" readonly="1" placeholder="Auto"/>
                </div>
                <field name="invoice_id" 
                       invisible="not is_warranty_team"
                       required="is_warranty_team"
                       context="{'default_partner_id': partner_id, 'default_move_type': 'out_invoice'}"
                       options="{'no_create': True}"/>
                <field name="available_product_ids" invisible="1"/>
                <field name="product_ids" 
                       invisible="not is_warranty_team or not invoice_id"
                       widget="many2many_tags"
                       domain="[('id', 'in', available_product_ids)]"
                       options="{'no_create': True, 'no_open': True}"/>
            </xpath>

        </field>
    </record>
</odoo>